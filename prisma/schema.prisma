// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS
enum Role {
  OWNER
  ADMIN
  STAFF
  FINANCE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
}

enum TransactionStatus {
  CONFIRMED
  FAILED
  CANCELLED
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

enum DeliverySpeed {
  FAST
  NORMAL
  BATCH
}

enum CampaignStatus {
  DRAFT
  RUNNING
  COMPLETED
  FAILED
}

model User {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email      String   @unique
  fullName   String   @map("full_name")
  avatarUrl  String?  @map("avatar_url")
  password   String   @db.Text
  phone      String?  @db.Text
  isVerified Boolean  @default(false) @map("is_verified")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  tenants TenantMember[]
  apikeys ApiKey[]
  // ownedTenant Tenant[]       @relation("TenantOwner")

  @@map("users")
}

model Tenant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  // ownerId   String   @map("owner_id") @db.Uuid
  balance   Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // owner   User           @relation("TenantOwner", fields: [ownerId], references: [id])
  members TenantMember[]

  // Financial => Tách ra các khoản phí và refund cho rõ ràng
  messageCharges      MessageCharge[]
  subscriptionCharges SubscriptionCharge[]
  topupTransactions   TopupTransaction[]
  refundTransactions  RefundTransaction[]

  // Business  
  subscriptions Subscription[]
  zaloOas       ZaloOa[]
  apiKeys       ApiKey[]
  znsTemplates  ZnsTemplate[]
  campaigns     Campaign[]
  messageLogs   MessageLog[]

  @@map("tenants")
}

model TenantMember {
  userId   String   @map("user_id") @db.Uuid
  tenantId String   @map("tenant_id") @db.Uuid
  role     Role
  joinedAt DateTime @default(now()) @map("joined_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@id([userId, tenantId])
  @@map("tenant_members")
}

model Plan {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  monthlyFee Int      @map("monthly_fee")
  messageFee Int      @map("message_fee")
  maxUsers   Int      @map("max_users")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id                 String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String             @map("tenant_id") @db.Uuid
  planId             Int                @map("plan_id")
  status             SubscriptionStatus
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  createdAt          DateTime           @default(now()) @map("created_at")

  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan                Plan                 @relation(fields: [planId], references: [id])
  subscriptionCharges SubscriptionCharge[]

  @@map("subscriptions")
}

model SubscriptionCharge {
  id             String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId       String            @map("tenant_id") @db.Uuid
  subscriptionId String            @map("subscription_id") @db.Uuid
  amount         Int
  billingPeriod  String            @map("billing_period")
  description    String
  status         TransactionStatus @default(CONFIRMED)
  chargedAt      DateTime          @default(now()) @map("charged_at")

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([tenantId, billingPeriod])
  @@map("subscription_charges")
}

model ZaloOa {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  oaIdZalo     String   @unique @map("oa_id_zalo")
  oaName       String   @map("oa_name")
  accessToken  String   @map("access_token")
  refreshToken String   @map("refresh_token")
  isActive     Boolean  @map("is_active")
  oaMeta       Json?    @map("oa_meta")
  createdAt    DateTime @default(now()) @map("created_at")

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messageLogs MessageLog[]

  @@map("zalo_oas")
}

model ApiKey {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId   String    @map("tenant_id") @db.Uuid
  creatorId  String    @map("creator_id") @db.Uuid
  keyHash    String    @unique @map("key_hash")
  prefix     String
  name       String
  lastUsedAt DateTime? @map("last_used_at")
  isActive   Boolean   @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")

  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator User   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model ZnsTemplate {
  id              String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String  @map("tenant_id") @db.Uuid
  oaId            String  @map("oa_id")
  templateId      String  @unique @map("template_id")
  templateName    String  @map("template_name")
  status          String  @default("PENDING")
  isActive        Boolean @map("is_active")
  price           Int     @default(0) @map("price")
  listParams      Json?   @map("template_params")
  previewUrl      String  @map("preview_url")
  timeout         Int
  templateQuality String? @map("template_quality")
  templateTag     String  @map("template_tag")

  createdAt DateTime @default(now()) @map("created_at")

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messageLogs MessageLog[]

  @@map("zns_templates")
}

model Campaign {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String         @map("tenant_id") @db.Uuid
  name            String
  status          CampaignStatus @default(DRAFT)
  totalRecipients Int            @default(0) @map("total_recipients")
  estimatedCost   Int            @default(0) @map("estimated_cost")
  actualCost      Int            @default(0) @map("actual_cost")
  startedAt       DateTime?      @map("started_at")
  completedAt     DateTime?      @map("completed_at")
  createdAt       DateTime       @default(now()) @map("created_at")

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messageLogs MessageLog[]

  @@index([tenantId, status])
  @@map("campaigns")
}

model MessageLog {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId        String        @map("tenant_id") @db.Uuid
  zaloOaId        String        @map("zalo_oa_id")
  templateId      String        @map("template_id")
  campaignId      String?       @map("campaign_id") @db.Uuid
  recipientPhone  String        @map("recipient_phone")
  recipientZaloId String?       @map("recipient_zalo_id")
  trackingId      String        @unique @map("tracking_id")
  msgId           String?       @map("msg_id")
  status          MessageStatus @default(PENDING)
  deliverySpeed   DeliverySpeed @map("delivery_speed")
  templateData    Json          @map("template_data")
  sentAt          DateTime?     @map("sent_at")
  deliveredAt     DateTime?     @map("delivered_at")
  failedAt        DateTime?     @map("failed_at")
  errorMessage    String?       @map("error_message")
  createdAt       DateTime      @default(now()) @map("created_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  zaloOa        ZaloOa         @relation(fields: [zaloOaId], references: [oaIdZalo])
  template      ZnsTemplate    @relation(fields: [templateId], references: [templateId])
  campaign      Campaign?      @relation(fields: [campaignId], references: [id])
  messageCharge MessageCharge?

  @@unique([tenantId, trackingId], name: "uniq_tenant_tracking")
  @@index([tenantId, createdAt])
  @@index([status, createdAt])
  @@index([campaignId, status])
  @@map("message_logs")
}

model MessageCharge {
  id           String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId     String            @map("tenant_id") @db.Uuid
  messageLogId String            @unique @map("message_log_id") @db.Uuid
  amount       Int
  baseZnsFee   Int               @map("base_zns_fee")
  deliveryFee  Int               @map("delivery_fee")
  platformFee  Int               @map("platform_fee")
  vatAmount    Int               @map("vat_amount")
  status       TransactionStatus @default(CONFIRMED)
  chargedAt    DateTime          @default(now()) @map("charged_at")

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messageLog MessageLog @relation(fields: [messageLogId], references: [id])

  @@index([tenantId, chargedAt])
  @@index([status, chargedAt])
  @@map("message_charges")
}

model TopupTransaction {
  id            String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId      String            @map("tenant_id") @db.Uuid
  amount        Int
  paymentMethod String            @map("payment_method")
  paymentRef    String?           @map("payment_ref")
  status        TransactionStatus @default(CONFIRMED)
  notes         String?
  createdAt     DateTime          @default(now()) @map("created_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@map("topup_transactions")
}

// 4. Refund transactions - Hoàn tiền nếu gửi fail sau đó (Gửi batch)
model RefundTransaction {
  id                 String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tenantId           String            @map("tenant_id") @db.Uuid
  originalChargeId   String            @map("original_charge_id") @db.Uuid
  originalChargeType String            @map("original_charge_type")
  amount             Int
  reason             String
  status             TransactionStatus @default(CONFIRMED)
  processedAt        DateTime          @default(now()) @map("processed_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, processedAt])
  @@index([originalChargeId, originalChargeType])
  @@map("refund_transactions")
}
